import { bot } from './telegram'
import { TelegramBot } from 'node-telegram-bot-api'

// URL –≤–∞—à–µ–≥–æ Mini App (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π URL –ø—Ä–∏ –¥–µ–ø–ª–æ–µ)
const MINI_APP_URL = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.onText(/\/start/, async (msg: TelegramBot.Message) => {
  const chatId = msg.chat.id
  
  await bot.sendMessage(chatId, '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üëã\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–≤—É—à–∫—É –¥–ª—è –æ–±—â–µ–Ω–∏—è:', {
    reply_markup: {
      inline_keyboard: [
        [
          {
            text: '–û—Ç–∫—Ä—ã—Ç—å Mini App üëâ',
            web_app: { url: MINI_APP_URL }
          }
        ]
      ]
    }
  })
})

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
bot.onText(/\/help/, async (msg: TelegramBot.Message) => {
  const chatId = msg.chat.id
  
  await bot.sendMessage(chatId, `
ü§ñ –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:

/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É

–î–ª—è –æ–±—â–µ–Ω–∏—è —Å –¥–µ–≤—É—à–∫–∞–º–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Mini App, –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –º–µ–Ω—é.
  `)
})

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∫—Ä–æ–º–µ –∫–æ–º–∞–Ω–¥)
bot.on('message', async (msg: TelegramBot.Message) => {
  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
  if (msg.text?.startsWith('/')) {
    return
  }
  
  const chatId = msg.chat.id
  
  // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—å Mini App
  await bot.sendMessage(chatId, '–î–ª—è –æ–±—â–µ–Ω–∏—è —Å –¥–µ–≤—É—à–∫–∞–º–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ Mini App —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:', {
    reply_markup: {
      inline_keyboard: [
        [
          {
            text: '–û—Ç–∫—Ä—ã—Ç—å Mini App üëâ',
            web_app: { url: MINI_APP_URL }
          }
        ]
      ]
    }
  })
})

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.on('polling_error', (error) => {
  console.error('–û—à–∏–±–∫–∞ polling:', error)
})

console.log('Telegram –±–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')

